// Prisma schema for MongoDB
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Application {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Applicant Information
  applicantName      String
  email              String
  phone              String
  position           String
  yearsOfExperience  Int
  availabilityDate   DateTime?
  currentLocation    String?
  arabicProficiency  String?
  englishProficiency String?
  consentToDataUsage Boolean   @default(false)

  // Optional URLs
  portfolioUrl String?
  githubUrl    String?
  linkedinUrl  String?

  // Skills and Documents
  skills      String[] // Array of skill strings
  coverLetter String
  cvUrl       String // Cloudinary URL
  cvPublicId  String // Cloudinary public ID for deletion

  // Personal Image
  profileImageUrl      String // Cloudinary URL for profile image (required)
  profileImagePublicId String // Cloudinary public ID for deletion (required)

  // Application Status
  status     ApplicationStatus @default(PENDING)
  adminNotes String?

  // Interview Response
  lastJobExitReason            String?
  lastSalary                   String?
  expectedSalary               String?
  canWorkHard                  Boolean?
  noticePeriod                 String?
  preferredWorkLocation        String?
  whyInterestedInPosition      String?
  questionsAboutRole           String?
  willingnessToRelocate        Boolean?
  bestInterviewTime            String?
  interviewResponseSubmittedAt DateTime?
  scheduledInterviewDate       DateTime?
  appointmentConfirmed         Boolean   @default(false)

  // Metadata
  locale String @default("ar") // ar or en

  // Relations
  staff Staff?

  @@index([status])
  @@index([position])
  @@index([email])
  @@index([createdAt])
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  ACCEPTED
  REJECTED
}

model Phase1Requirement {
  id        String              @id @default(auto()) @map("_id") @db.ObjectId
  category  String
  title     String
  status    RequirementStatus   @default(PENDING)
  priority  RequirementPriority
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@index([category])
  @@index([status])
}

enum RequirementStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum RequirementPriority {
  HIGH
  MEDIUM
  LOW
}

model Transaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Transaction Details
  type             TransactionType
  amount           Float
  description      String
  category         String?
  categoryId       String?         @db.ObjectId
  categoryRelation Category?       @relation("TransactionCategory", fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  date             DateTime

  // Invoice Image (for expenses only)
  invoiceImageUrl      String?
  invoiceImagePublicId String?

  @@index([type])
  @@index([date])
  @@index([category])
  @@index([categoryId])
  @@index([createdAt])
}

enum TransactionType {
  EXPENSE
  REVENUE
}

model ContactMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fullName String
  email    String
  phone    String?
  subject  String
  message  String
  locale   String  @default("en")
  source   String  @default("contact-form")

  @@index([createdAt])
  @@index([locale])
}

model InterviewResult {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicationId   String                @db.ObjectId
  interviewDate   DateTime
  result          InterviewResultStatus
  rating          Int?
  interviewerName String?
  strengths       String[]
  weaknesses      String[]
  notes           String?
  recommendation  String?

  @@unique([applicationId])
  @@index([result])
  @@index([interviewDate])
}

enum InterviewResultStatus {
  PASSED
  FAILED
  PENDING
}

model Staff {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Deprecated fields (for backward compatibility)
  name              String?
  email             String?
  phone             String?
  position          String?
  yearsOfExperience Int?
  skills            String[]
  profileImageUrl   String?
  cvUrl             String?
  cvPublicId        String?

  // HR fields
  employeeId String?
  department String?
  hireDate   DateTime
  salary     Float?
  status     StaffStatus
  notes      String?

  // New HR fields
  username           String?
  officialEmail      String?
  trialStartDate     DateTime?
  trialEndDate       DateTime?
  trialMonths        Int?
  trialSalary        Float?
  ndaSignedDate      DateTime?
  contractSignedDate DateTime?
  currency           String    @default("SAR")
  emergencyContact1  Json?
  emergencyContact2  Json?

  // Clockify Integration
  clockifyUserId String?

  // Relations
  applicationId String?      @unique @db.ObjectId
  application   Application? @relation(fields: [applicationId], references: [id])
  userId        String?      @unique @db.ObjectId
  user          User?        @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([department])
  @@index([employeeId])
  @@index([clockifyUserId])
}

enum StaffStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email     String    @unique
  password  String
  name      String?
  role      UserRole
  isActive  Boolean   @default(true)
  lastLogin DateTime?

  // Relations
  staff       Staff?
  permissions UserRoutePermission[]

  @@index([role])
  @@index([isActive])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  STAFF
}

model UserRoutePermission {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  route  String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, route])
  @@index([userId])
  @@index([route])
}

model Category {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  key       String       @unique
  label     String
  parentKey String?
  type      CategoryType
  order     Int          @default(0)
  isActive  Boolean      @default(true)

  // Relations
  costs        Cost[]
  children     Category[]    @relation("CategoryChildren")
  parent       Category?     @relation("CategoryChildren", fields: [parentKey], references: [key], onDelete: NoAction, onUpdate: NoAction)
  transactions Transaction[] @relation("TransactionCategory")

  @@index([type])
  @@index([parentKey])
  @@index([isActive])
}

enum CategoryType {
  EXPENSE
  REVENUE
}

model Cost {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  amount      Float
  type        CostType
  categoryId  String?   @db.ObjectId
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  description String?
  date        DateTime

  @@index([type])
  @@index([categoryId])
  @@index([date])
}

enum CostType {
  FIXED
  VARIABLE
}

model SourceOfIncome {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  type        SourceOfIncomeType
  amount      Float
  description String?
  date        DateTime

  @@index([type])
  @@index([date])
}

enum SourceOfIncomeType {
  SUBSCRIPTION
  ONE_TIME
  RECURRING
}

model Task {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String
  description String?
  status      TaskStatus
  priority    TaskPriority
  dueDate     DateTime?
  completedAt DateTime?

  createdByUserId  String @db.ObjectId
  assignedToUserId String @db.ObjectId

  @@index([status])
  @@index([priority])
  @@index([createdByUserId])
  @@index([assignedToUserId])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model ManagementNote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title           String
  content         String
  type            NoteType
  targetAudience  TargetAudience
  targetUserId    String?        @db.ObjectId
  department      String?
  isImportant     Boolean        @default(false)
  rewardAmount    Float?
  rewardCurrency  String?
  readBy          String[]
  parentNoteId    String?        @db.ObjectId
  createdByUserId String         @db.ObjectId

  @@index([type])
  @@index([targetAudience])
  @@index([targetUserId])
  @@index([department])
  @@index([createdByUserId])
  @@index([parentNoteId])
}

enum NoteType {
  ANNOUNCEMENT
  TASK
  REWARD
  GENERAL
}

enum TargetAudience {
  ALL
  ADMIN
  STAFF
  SPECIFIC_USER
  SPECIFIC_DEPARTMENT
}

model BMCCanvas {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sectionId String
  content   Json

  @@unique([sectionId])
}
